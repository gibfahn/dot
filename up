#!/usr/bin/env bash

# Runs the setup to "install" my dotfiles on your machine. Runs scripts in
# config/ and then runs ./link.

set -e

LOG_FILE=$HOME/tmp/dot-tmp.log
rm -f "$LOG_FILE"
touch "$LOG_FILE"

exec > >(tee -a "$LOG_FILE") 2>&1

echo -e "Running up script at $(date --iso-8601=seconds)"

env

cd "$(dirname "$0")"

. ./helpers/setup.sh # Load helper script from dot/helpers.

# TODO(gib): Need a better way to opt-in or out of different things than
# HARDCORE and NO_SUDO options. Ideally there should be a config that remembers
# your choices too.
if [[ "$USER" == gib ]]; then
  # - not :- because set to "" means explicitly disabled.
  export HARDCORE=${HARDCORE-1}
else
  export HARDCORE=${HARDCORE-""}
fi

if [[ "$HARDCORE" ]]; then
  log_get "HARDCORE mode"
else
  log_skip "HARDCORE skipping"
fi

# Good defaults:
[ -z "$XDG_CONFIG_HOME" ] && export XDG_CONFIG_HOME="$HOME/.config"
[ -z "$XDG_CACHE_HOME" ] && export XDG_CACHE_HOME="$HOME/.cache"
[ -z "$XDG_DATA_HOME" ] && export XDG_DATA_HOME="$HOME/.local/share"

if ! exists up; then
  log_get "Installing up-rs"
  curl --create-dirs -Lo ~/bin/up https://github.com/gibfahn/up-rs/releases/latest/download/up-darwin
  chmod +x ~/bin/up
else
  log_skip "Installing up-rs"
fi

# Setup dotfile symlinks.
# TODO(gib): enable these once up supports updating.
# --git-url https://github.com/gibfahn/dot \
# --git-path $PWD/dot \
# up link \
#   --from "$PWD"/dotfiles \
#   --to ~ \
#   --backup ~/backup
# Platform specific setup:
if [ "$(uname)" = Darwin ]; then # macOS
  "$(dirname "$0")"/setup/mac.sh
elif [ "$(uname)" = Linux ]; then # Linux specific stuff.
  distro="$(cat /etc/*-release | grep '^ID=' | sed -E 's/^ID="?(.*)"?/\1/' | head -1)"
  case "$distro" in
    *[Uu]buntu*) "$(dirname "$0")"/setup/ubuntu.sh ;;
    *[Aa]lpine*) "$(dirname "$0")"/setup/alpine.sh || exit 1;;
    *) echo "No specific setup files for $distro yet" ;;
  esac
fi

# Cross-platform setup:
./setup/unix.sh

# Check for unpushed git changes.
./setup/unpushed_git.sh

finalOutput INSTALL
